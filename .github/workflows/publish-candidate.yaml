name: Publish Candidate - Publish on Candidate Update

on:
    push:
        branches:
            - candidate

jobs:
    publish-candidate:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Check if Commit is a Version Bump
              id: check_commit
              run: |
                  COMMIT_MESSAGE=$(git log -1 --pretty=%B)
                  echo "Latest commit message: $COMMIT_MESSAGE"
                  if [[ "$COMMIT_MESSAGE" == *"[version-bump]"* ]]; then
                    echo "is_version_bump=true" >> $GITHUB_OUTPUT
                  else
                    echo "is_version_bump=false" >> $GITHUB_OUTPUT
                  fi

            - name: Notify Non-Version Bump Commit
              if: steps.check_commit.outputs.is_version_bump != 'true'
              run: echo "Not a version bump commit. Exiting workflow."

            - name: Set Up Node.js
              if: steps.check_commit.outputs.is_version_bump == 'true'
              uses: actions/setup-node@v4
              with:
                  node-version: '18.x'
                  registry-url: 'https://registry.npmjs.org'

            - name: Install Dependencies
              if: steps.check_commit.outputs.is_version_bump == 'true'
              run: yarn install --no-immutable

            - name: Build Packages
              if: steps.check_commit.outputs.is_version_bump == 'true'
              run: yarn build

            - name: Publish Packages to NPM
              if: steps.check_commit.outputs.is_version_bump == 'true'
              run: |
                  PACKAGES=("ketchup-lite" "ketchup-lite-react" "ketchup-lite-react-ssr" "ketchup-lite-hydrate")
                  for pkg in "${PACKAGES[@]}"; do
                    echo "Publishing ${pkg}"
                    cd packages/${pkg}
                    npm publish --tag rc
                    cd ../../
                  done
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
