name: Publish Candidate - Version Bump and PR Creation

on:
    push:
        branches:
            - candidate

jobs:
    version-bump:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Required for creating branches and accessing full history

            - name: Set Up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18.x'
                  registry-url: 'https://registry.npmjs.org'

            - name: Install Dependencies
              run: yarn install --no-immutable

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Update Versions with Lerna
              run: |
                  # Bump versions with Lerna in prerelease mode
                  npx lerna version prerelease --preid=rc --no-push --yes

            - name: Format with Prettier
              run: yarn lint --write "packages/**/*.{js,jsx,ts,tsx,json,md}"

            - name: Commit Version Bumps and Formatting
              run: |
                  git add .
                  git commit -m "Bump versions and format code with Prettier [version-bump]" || echo "No changes to commit"

            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v5
              with:
                  commit-message: 'Bump versions and format code with Prettier [version-bump]'
                  branch: 'version-bump-${{ github.run_id }}'
                  title: 'Bump Versions and Format Code for Candidate Release'
                  body: |
                      This PR bumps the versions of all packages and applies formatting changes using Prettier to prepare for a candidate release.
                  base: 'candidate'
                  labels: 'automated PR'
