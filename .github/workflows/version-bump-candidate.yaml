name: Publish Candidate - Version Bump and PR Creation

on:
    push:
        branches:
            - candidate

jobs:
    setup:
        uses: ./.github/workflows/setup.yml
        with:
            node-version: '18.x'
            install-immutable: true
        secrets:
            NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

    version-bump:
        needs: setup
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Required for creating branches and accessing full history

            - name: Set Up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18.x'
                  registry-url: 'https://registry.npmjs.org'

            - name: Install Dependencies
              run: yarn install --immutable

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Bump Versions with Lerna (Prerelease)
              run: |
                  npx lerna version prerelease --preid=rc --no-push --yes

            - name: Format Code with Prettier
              run: yarn format --write "packages/*/src/**/*.{scss,ts,tsx,json}"

            - name: Lint Code
              run: yarn lint --write "packages/*/src/**/*.{scss,ts,tsx,json}"

            - name: Commit Version Bumps and Formatting
              run: |
                  git add .
                  git commit -m "Bump versions to pre-release and format code with Prettier [version-bump]" || echo "No changes to commit"

            - name: Push Changes to Candidate Branch
              uses: ad-m/github-push-action@v0.6.0
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  branch: candidate
                  force: false

            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v5
              with:
                  commit-message: 'Bump versions to pre-release and format code with Prettier [version-bump]'
                  branch: 'version-bump-${{ github.run_id }}'
                  title: 'Bump Versions and Format Code for Candidate Release'
                  body: |
                      This PR bumps the versions of all packages to a pre-release and applies formatting changes using Prettier to prepare for a candidate release.
                  base: 'candidate'
                  labels: 'automated PR'
